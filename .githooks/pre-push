#!/bin/sh

echo "üîç Running PMD and SpotBugs before pushing..."
echo "============================================="

# Run PMD and capture output
echo "üöÄ Running PMD..."
PMD_OUTPUT=$(mvn pmd:check 2>&1)
PMD_STATUS=$?

# Extract PMD violations
PMD_XML_PATH="target/pmd.xml"
if [ -f "$PMD_XML_PATH" ]; then
    echo "üìÑ Extracting PMD violations from $PMD_XML_PATH..."
    PMD_ERRORS=$(xmllint --format "$PMD_XML_PATH" | grep -E "<violation" | sed -E 's/<violation.*>(.*)<\/violation>/\1/g')
else
    PMD_ERRORS="‚ö†Ô∏è PMD report not found. Check manually: $PMD_XML_PATH"
fi

# Run SpotBugs and capture output
echo "üöÄ Running SpotBugs..."
SPOTBUGS_OUTPUT=$(mvn spotbugs:check 2>&1)
SPOTBUGS_STATUS=$?

# Extract SpotBugs warnings and errors
SPOTBUGS_ERRORS=$(echo "$SPOTBUGS_OUTPUT" | grep -E "(Bug|ERROR|WARN)")

# Check if PMD found issues
if [ $PMD_STATUS -ne 0 ]; then
    echo "‚ùå PMD found issues:"
    echo "---------------------------------------------"
    echo "$PMD_ERRORS"
    echo "---------------------------------------------"
    echo "üìÑ Check full PMD report: $PMD_XML_PATH"
fi

# Check if SpotBugs found issues
if [ $SPOTBUGS_STATUS -ne 0 ]; then
    echo "‚ùå SpotBugs found issues:"
    echo "---------------------------------------------"
    echo "$SPOTBUGS_ERRORS"
    echo "---------------------------------------------"
fi

# If any issues are found, reject the push
if [ $PMD_STATUS -ne 0 ] || [ $SPOTBUGS_STATUS -ne 0 ]; then
    echo "‚ùå Pre-push rejected due to code issues detected by PMD or SpotBugs."
    exit 1
fi

echo "‚úÖ No issues found. Pushing code..."
exit 0
